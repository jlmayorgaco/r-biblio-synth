# ---------------------------------------------------------------------------- #
# Function: Generate Report for Document Types Analysis
# ---------------------------------------------------------------------------- #
fn_m1_mtrc1_generate_document_types_report <- function(v_document_types) {
  # Ensure the output directory exists
  report_dir <- "results/M1_Main_Information/reports"
  if (!dir.exists(report_dir)) {
    dir.create(report_dir, recursive = TRUE)
  }

  # Create a data frame for document types
  df <- data.frame(
    Document_Type = names(v_document_types),
    Count = sapply(v_document_types, function(x) ifelse(length(x) == 0, 0, x))
  )

  # Filter out document types with zero count and apply label mapping
  df <- df[df$Count > 0, ]
  df$Document_Type <- LABEL_MAPPING[df$Document_Type]

  # Sort the data by count in descending order
  df <- df[order(-df$Count), ]

  # Calculate percentages
  total_count <- sum(df$Count)
  df$Percentage <- round((df$Count / total_count) * 100, 2)

  # Generate a plain text report
  txt_report <- paste0(
    "Document Types Distribution Report\n",
    "==================================\n\n",
    "Total Articles: ", total_count, "\n\n",
    "Breakdown by Document Type:\n\n",
    paste(
      sprintf(
        "%-20s: %d (%.2f%%)", 
        df$Document_Type, df$Count, df$Percentage
      ),
      collapse = "\n"
    ),
    "\n\nGenerated by fn_m1_mtrc1_generate_document_types_report"
  )

  # Save the plain text report
  txt_file_path <- file.path(report_dir, "M1_Document_Types_Report.txt")
  writeLines(txt_report, txt_file_path)

  # Generate a LaTeX report
  tex_report <- paste0(
    "\\documentclass[12pt]{article}\n",
    "\\usepackage{geometry}\n",
    "\\usepackage{graphicx}\n",
    "\\geometry{a4paper, margin=1in}\n",
    "\\begin{document}\n",
    "\\title{Document Types Distribution Report}\n",
    "\\author{}\n",
    "\\date{\\today}\n",
    "\\maketitle\n",
    "\\section*{Overview}\n",
    "This report summarizes the distribution of document types in the dataset.\n",
    "The total number of articles analyzed is \\textbf{", total_count, "}.\n\n",
    "\\section*{Breakdown by Document Type}\n",
    "\\begin{itemize}\n",
    paste(
      sprintf(
        "\\item \\textbf{%s}: %d (%.2f\\%%)", 
        df$Document_Type, df$Count, df$Percentage
      ),
      collapse = "\n"
    ),
    "\n\\end{itemize}\n\n",
    "\\section*{Visualization}\n",
    "The distribution of document types is visualized in the accompanying pie chart.\n",
    "\\includegraphics[width=0.8\\textwidth]{../figures/M1_G2_DOCUMENT_TYPES_PIE_PLOT_PNG.png}\n",
    "\\end{document}"
  )

  # Save the LaTeX report
  tex_file_path <- file.path(report_dir, "M1_Document_Types_Report.tex")
  writeLines(tex_report, tex_file_path)

  # Log success
  message("[INFO] Document types reports generated successfully:")
  message("  - Plain text report: ", txt_file_path)
  message("  - LaTeX report: ", tex_file_path)
}
library(glue)

generate_document_types_report <- function(df, output_path) {
  # Ensure percentages are calculated
  total_count <- sum(df$Count)
  df$Percentage <- (df$Count / total_count) * 100
  
  # Determine key insights
  dominant_type <- df$Document_Type[which.max(df$Percentage)]
  dominant_percentage <- max(df$Percentage)
  evenly_distributed <- all(df$Percentage < 40) # No type has more than 40%

  # Generate conclusions dynamically
  if (dominant_percentage > 50) {
    conclusions <- glue(
      "The analysis reveals that the document type \\textbf{{{dominant_type}}} dominates the dataset, ",
      "representing \\textbf{{{round(dominant_percentage, 2)}}}\\% of all articles. ",
      "This suggests that most articles in this collection are focused on this specific type."
    )
  } else if (evenly_distributed) {
    conclusions <- glue(
      "The dataset shows an even distribution of document types, with no single type exceeding 40\\% of the total. ",
      "This indicates a diverse set of article formats in the collection."
    )
  } else {
    conclusions <- glue(
      "The document types are varied, with \\textbf{{{dominant_type}}} being the most common, ",
      "accounting for \\textbf{{{round(dominant_percentage, 2)}}}\\% of the total. ",
      "Other document types contribute significantly as well, indicating a balanced dataset."
    )
  }

  # Create LaTeX content
  latex_template <- "
\\documentclass[12pt]{article}
\\usepackage{geometry}
\\usepackage{graphicx}
\\geometry{a4paper, margin=1in}
\\begin{document}
\\title{Document Types Distribution Report}
\\author{}
\\date{\\today}
\\maketitle
\\section*{Overview}
The total number of articles analyzed is \\textbf{{{total_count}}}.
\\section*{Breakdown by Document Type}
\\begin{itemize}
{item_list}
\\end{itemize}
\\section*{Conclusions}
{conclusions}
\\section*{Visualization}
The distribution of document types is visualized in the accompanying pie chart:
\\includegraphics[width=0.8\\textwidth]{../figures/M1_G2_DOCUMENT_TYPES_PIE_PLOT_PNG.png}
\\end{document}
  "

  # Generate item list for LaTeX
  item_list <- paste(
    glue("\\item \\textbf{{{df$Document_Type}}}: {df$Count} ({round(df$Percentage, 2)}\\%)"),
    collapse = "\n"
  )

  # Fill the template with content
  content <- glue(latex_template,
                  total_count = total_count,
                  item_list = item_list,
                  conclusions = conclusions
  )

  # Save the LaTeX file
  writeLines(content, output_path)
}

